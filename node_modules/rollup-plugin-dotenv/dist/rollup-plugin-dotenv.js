'use strict'

Object.defineProperty(exports, '__esModule', { value: true })

var fs = require('fs')
var path = require('path')
var dotenv = require('dotenv')
var replace = require('@rollup/plugin-replace')

const mapKeys = (mapper, obj) =>
  Object.keys(obj).reduce((acc, key) => {
    acc[mapper(key)] = obj[key]
    return acc
  }, {})
const mapValues = (mapper, obj) =>
  Object.keys(obj).reduce((acc, key) => {
    acc[key] = mapper(obj[key])
    return acc
  }, {})
const pick = (props, obj) =>
  props.reduce((acc, prop) => {
    acc[prop] = obj[prop]
    return acc
  }, {})
const shallowMergeAll = (objs) => Object.assign({}, ...objs)

const withDefaults = ({ cwd = '.', envKey = 'NODE_ENV' } = {}) => ({
  cwd: path.resolve(process.cwd(), cwd),
  envKey,
})
function dotenvPlugin(inputOptions) {
  const { cwd, envKey } = withDefaults(inputOptions)
  return {
    ...replace({
      values: ((envVars) =>
        mapValues((value) => JSON.stringify(value), envVars))(
        ((envVars) => mapKeys((key) => `process.env.${key}`, envVars))(
          ((envVars) =>
            shallowMergeAll([
              envVars,
              pick(
                Object.keys(envVars).filter(
                  (key) => process.env[key] !== undefined,
                ),
                process.env,
              ),
            ]))(
            shallowMergeAll(
              ((priorities) =>
                [...priorities]
                  .reverse()
                  .map((dotenvFile) => path.join(cwd, dotenvFile))
                  .filter(fs.existsSync)
                  .map((dotenvFile) => fs.readFileSync(dotenvFile))
                  .map(dotenv.parse))([
                `.env.${process.env[envKey]}.local`,
                `.env.${process.env[envKey]}`,
                '.env.local',
                '.env',
              ]),
            ),
          ),
        ),
      ),
      preventAssignment: false,
    }),
    name: 'dotenv',
  }
}

exports.default = dotenvPlugin
