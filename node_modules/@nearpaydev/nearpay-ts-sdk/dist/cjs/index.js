"use strict";var e,t,n,r,o,i,s,a,c;let u;!function(e){e.Busy="busy",e.Paused="Paused",e.Paused_Mode="PausedAlready",e.Resume="Resume",e.Confirmed="confirmed",e.Unauthorized="unauthorized"}(e||(e={})),exports.PURCHASE_STATUS=void 0,(t=exports.PURCHASE_STATUS||(exports.PURCHASE_STATUS={}))[t.APPROVED=1]="APPROVED",t[t.DECLINED=2]="DECLINED",t[t.REJECTED=3]="REJECTED",t[t.AUTHENTICATION_FAILED=4]="AUTHENTICATION_FAILED",t[t.INVALID_DEVICE_STATUS=5]="INVALID_DEVICE_STATUS",t[t.GENERAL_FAILURE=6]="GENERAL_FAILURE",exports.REFUND_STATUS=void 0,(n=exports.REFUND_STATUS||(exports.REFUND_STATUS={}))[n.APPROVED=1]="APPROVED",n[n.DECLINED=2]="DECLINED",n[n.REJECTED=3]="REJECTED",n[n.AUTHENTICATION_FAILED=4]="AUTHENTICATION_FAILED",n[n.INVALID_DEVICE_STATUS=5]="INVALID_DEVICE_STATUS",n[n.GENERAL_FAILURE=6]="GENERAL_FAILURE",exports.REVERSAL_STATUS=void 0,(r=exports.REVERSAL_STATUS||(exports.REVERSAL_STATUS={}))[r.FINISHED=1]="FINISHED",r[r.REJECTED=2]="REJECTED",r[r.AUTHENTICATION_FAILED=3]="AUTHENTICATION_FAILED",r[r.INVALID_DEVICE_STATUS=4]="INVALID_DEVICE_STATUS",r[r.GENERAL_FAILURE=5]="GENERAL_FAILURE",exports.RECONCILIATION_STATUS=void 0,(o=exports.RECONCILIATION_STATUS||(exports.RECONCILIATION_STATUS={}))[o.BALANCED=1]="BALANCED",o[o.NOT_BALANCED=2]="NOT_BALANCED",o[o.REJECTED=3]="REJECTED",o[o.AUTHENTICATION_FAILED=4]="AUTHENTICATION_FAILED",o[o.INVALID_DEVICE_STATUS=5]="INVALID_DEVICE_STATUS",o[o.GENERAL_FAILURE=6]="GENERAL_FAILURE",exports.TRANSACTION_QUERY_STATUS=void 0,(i=exports.TRANSACTION_QUERY_STATUS||(exports.TRANSACTION_QUERY_STATUS={}))[i.FINISHED=1]="FINISHED",i[i.AUTHENTICATION_FAILED=3]="AUTHENTICATION_FAILED",i[i.INVALID_DEVICE_STATUS=4]="INVALID_DEVICE_STATUS",i[i.GENERAL_FAILURE=5]="GENERAL_FAILURE",exports.TRANSACTIONS_QUERY_STATUS=void 0,(s=exports.TRANSACTIONS_QUERY_STATUS||(exports.TRANSACTIONS_QUERY_STATUS={}))[s.FINISHED=1]="FINISHED",s[s.AUTHENTICATION_FAILED=2]="AUTHENTICATION_FAILED",s[s.INVALID_DEVICE_STATUS=3]="INVALID_DEVICE_STATUS",s[s.GENERAL_FAILURE=4]="GENERAL_FAILURE",exports.RECONCILIATIONS_QUERY_STATUS=void 0,(a=exports.RECONCILIATIONS_QUERY_STATUS||(exports.RECONCILIATIONS_QUERY_STATUS={}))[a.FINISHED=1]="FINISHED",a[a.AUTHENTICATION_FAILED=2]="AUTHENTICATION_FAILED",a[a.INVALID_DEVICE_STATUS=3]="INVALID_DEVICE_STATUS",a[a.GENERAL_FAILURE=4]="GENERAL_FAILURE",exports.RECONCILIATION_QUERY_STATUS=void 0,(c=exports.RECONCILIATION_QUERY_STATUS||(exports.RECONCILIATION_QUERY_STATUS={}))[c.BALANCED=1]="BALANCED",c[c.NOT_BALANCED=2]="NOT_BALANCED",c[c.REJECTED=3]="REJECTED",c[c.AUTHENTICATION_FAILED=4]="AUTHENTICATION_FAILED",c[c.INVALID_DEVICE_STATUS=5]="INVALID_DEVICE_STATUS",c[c.GENERAL_FAILURE=6]="GENERAL_FAILURE";const h=new Uint8Array(16);function l(){if(!u&&(u="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto),!u))throw new Error("crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported");return u(h)}const d=[];for(let e=0;e<256;++e)d.push((e+256).toString(16).slice(1));var f,p={randomUUID:"undefined"!=typeof crypto&&crypto.randomUUID&&crypto.randomUUID.bind(crypto)};function g(e,t,n){if(p.randomUUID&&!t&&!e)return p.randomUUID();const r=(e=e||{}).random||(e.rng||l)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t){n=n||0;for(let e=0;e<16;++e)t[n+e]=r[e];return t}return function(e,t=0){return(d[e[t+0]]+d[e[t+1]]+d[e[t+2]]+d[e[t+3]]+"-"+d[e[t+4]]+d[e[t+5]]+"-"+d[e[t+6]]+d[e[t+7]]+"-"+d[e[t+8]]+d[e[t+9]]+"-"+d[e[t+10]]+d[e[t+11]]+d[e[t+12]]+d[e[t+13]]+d[e[t+14]]+d[e[t+15]]).toLowerCase()}(r)}exports.CONNECTION_STATE=void 0,(f=exports.CONNECTION_STATE||(exports.CONNECTION_STATE={})).CONNECTED="connected",f.CONNECTING="connecting",f.DISCONNECTED="disconnected",f.LOGGED_OUT="logged_out";const E=e=>{};class T{static async connect(e,{onConnected:t=E,ondisconnected:n=E,onError:r=E,onMessage:o=E}){const i=new WebSocket(e);i.binaryType="arraybuffer";const s=new Promise(((e,s)=>{i?.addEventListener("open",(n=>{t(n),e(void 0)})),i?.addEventListener("close",n),i?.addEventListener("error",(e=>{r(e),s("Can't reach the given address")})),i?.addEventListener("message",o)}));return[i,s]}}class v{nearpay;connection_manager;listener;connectionInfo;connect(e){throw`please override the function ${arguments.callee.toString()} reconnect on the class (${this.constructor.name})`}disconnect(e){throw`please override the function ${arguments.callee.toString()}  on the class (${this.constructor.name})`}send(e){throw`please override the function ${arguments.callee.toString()}  on the class (${this.constructor.name})`}reconnect(e){throw`please override the function ${arguments.callee.toString()}  on the class (${this.constructor.name})`}isConnected(){throw`please override the function ${arguments.callee.toString()}  on the class (${this.constructor.name})`}getType(){throw`please override the function ${arguments.callee.toString()}  on the class (${this.constructor.name})`}getName(){throw`please override the function ${arguments.callee.toString()}  on the class (${this.constructor.name})`}getInfo(){throw`please override the function ${arguments.callee.toString()}  on the class (${this.constructor.name})`}getConnectionInfo(){return this.connectionInfo}constructor(e,t,n,r){this.nearpay=e,this.connection_manager=t,this.listener=n,this.connectionInfo=r}}var y="undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{},_=[],b=[],A="undefined"!=typeof Uint8Array?Uint8Array:Array,I=!1;function N(){I=!0;for(var e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",t=0,n=e.length;t<n;++t)_[t]=e[t],b[e.charCodeAt(t)]=t;b["-".charCodeAt(0)]=62,b["_".charCodeAt(0)]=63}function C(e,t,n){for(var r,o,i=[],s=t;s<n;s+=3)r=(e[s]<<16)+(e[s+1]<<8)+e[s+2],i.push(_[(o=r)>>18&63]+_[o>>12&63]+_[o>>6&63]+_[63&o]);return i.join("")}function m(e){var t;I||N();for(var n=e.length,r=n%3,o="",i=[],s=16383,a=0,c=n-r;a<c;a+=s)i.push(C(e,a,a+s>c?c:a+s));return 1===r?(t=e[n-1],o+=_[t>>2],o+=_[t<<4&63],o+="=="):2===r&&(t=(e[n-2]<<8)+e[n-1],o+=_[t>>10],o+=_[t>>4&63],o+=_[t<<2&63],o+="="),i.push(o),i.join("")}function R(e,t,n,r,o){var i,s,a=8*o-r-1,c=(1<<a)-1,u=c>>1,h=-7,l=n?o-1:0,d=n?-1:1,f=e[t+l];for(l+=d,i=f&(1<<-h)-1,f>>=-h,h+=a;h>0;i=256*i+e[t+l],l+=d,h-=8);for(s=i&(1<<-h)-1,i>>=-h,h+=r;h>0;s=256*s+e[t+l],l+=d,h-=8);if(0===i)i=1-u;else{if(i===c)return s?NaN:1/0*(f?-1:1);s+=Math.pow(2,r),i-=u}return(f?-1:1)*s*Math.pow(2,i-r)}function w(e,t,n,r,o,i){var s,a,c,u=8*i-o-1,h=(1<<u)-1,l=h>>1,d=23===o?Math.pow(2,-24)-Math.pow(2,-77):0,f=r?0:i-1,p=r?1:-1,g=t<0||0===t&&1/t<0?1:0;for(t=Math.abs(t),isNaN(t)||t===1/0?(a=isNaN(t)?1:0,s=h):(s=Math.floor(Math.log(t)/Math.LN2),t*(c=Math.pow(2,-s))<1&&(s--,c*=2),(t+=s+l>=1?d/c:d*Math.pow(2,1-l))*c>=2&&(s++,c/=2),s+l>=h?(a=0,s=h):s+l>=1?(a=(t*c-1)*Math.pow(2,o),s+=l):(a=t*Math.pow(2,l-1)*Math.pow(2,o),s=0));o>=8;e[n+f]=255&a,f+=p,a/=256,o-=8);for(s=s<<o|a,u+=o;u>0;e[n+f]=255&s,f+=p,s/=256,u-=8);e[n+f-p]|=128*g}var S={}.toString,O=Array.isArray||function(e){return"[object Array]"==S.call(e)};function L(){return D.TYPED_ARRAY_SUPPORT?2147483647:1073741823}function U(e,t){if(L()<t)throw new RangeError("Invalid typed array length");return D.TYPED_ARRAY_SUPPORT?(e=new Uint8Array(t)).__proto__=D.prototype:(null===e&&(e=new D(t)),e.length=t),e}function D(e,t,n){if(!(D.TYPED_ARRAY_SUPPORT||this instanceof D))return new D(e,t,n);if("number"==typeof e){if("string"==typeof t)throw new Error("If encoding is specified then the first argument must be a string");return B(this,e)}return P(this,e,t,n)}function P(e,t,n,r){if("number"==typeof t)throw new TypeError('"value" argument must not be a number');return"undefined"!=typeof ArrayBuffer&&t instanceof ArrayBuffer?function(e,t,n,r){if(t.byteLength,n<0||t.byteLength<n)throw new RangeError("'offset' is out of bounds");if(t.byteLength<n+(r||0))throw new RangeError("'length' is out of bounds");t=void 0===n&&void 0===r?new Uint8Array(t):void 0===r?new Uint8Array(t,n):new Uint8Array(t,n,r);D.TYPED_ARRAY_SUPPORT?(e=t).__proto__=D.prototype:e=F(e,t);return e}(e,t,n,r):"string"==typeof t?function(e,t,n){"string"==typeof n&&""!==n||(n="utf8");if(!D.isEncoding(n))throw new TypeError('"encoding" must be a valid string encoding');var r=0|V(t,n);e=U(e,r);var o=e.write(t,n);o!==r&&(e=e.slice(0,o));return e}(e,t,n):function(e,t){if(Y(t)){var n=0|j(t.length);return 0===(e=U(e,n)).length||t.copy(e,0,0,n),e}if(t){if("undefined"!=typeof ArrayBuffer&&t.buffer instanceof ArrayBuffer||"length"in t)return"number"!=typeof t.length||(r=t.length)!=r?U(e,0):F(e,t);if("Buffer"===t.type&&O(t.data))return F(e,t.data)}var r;throw new TypeError("First argument must be a string, Buffer, ArrayBuffer, Array, or array-like object.")}(e,t)}function x(e){if("number"!=typeof e)throw new TypeError('"size" argument must be a number');if(e<0)throw new RangeError('"size" argument must not be negative')}function B(e,t){if(x(t),e=U(e,t<0?0:0|j(t)),!D.TYPED_ARRAY_SUPPORT)for(var n=0;n<t;++n)e[n]=0;return e}function F(e,t){var n=t.length<0?0:0|j(t.length);e=U(e,n);for(var r=0;r<n;r+=1)e[r]=255&t[r];return e}function j(e){if(e>=L())throw new RangeError("Attempt to allocate Buffer larger than maximum size: 0x"+L().toString(16)+" bytes");return 0|e}function Y(e){return!(null==e||!e._isBuffer)}function V(e,t){if(Y(e))return e.length;if("undefined"!=typeof ArrayBuffer&&"function"==typeof ArrayBuffer.isView&&(ArrayBuffer.isView(e)||e instanceof ArrayBuffer))return e.byteLength;"string"!=typeof e&&(e=""+e);var n=e.length;if(0===n)return 0;for(var r=!1;;)switch(t){case"ascii":case"latin1":case"binary":return n;case"utf8":case"utf-8":case void 0:return fe(e).length;case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return 2*n;case"hex":return n>>>1;case"base64":return pe(e).length;default:if(r)return fe(e).length;t=(""+t).toLowerCase(),r=!0}}function M(e,t,n){var r=!1;if((void 0===t||t<0)&&(t=0),t>this.length)return"";if((void 0===n||n>this.length)&&(n=this.length),n<=0)return"";if((n>>>=0)<=(t>>>=0))return"";for(e||(e="utf8");;)switch(e){case"hex":return ne(this,t,n);case"utf8":case"utf-8":return Z(this,t,n);case"ascii":return ee(this,t,n);case"latin1":case"binary":return te(this,t,n);case"base64":return X(this,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return re(this,t,n);default:if(r)throw new TypeError("Unknown encoding: "+e);e=(e+"").toLowerCase(),r=!0}}function G(e,t,n){var r=e[t];e[t]=e[n],e[n]=r}function k(e,t,n,r,o){if(0===e.length)return-1;if("string"==typeof n?(r=n,n=0):n>2147483647?n=2147483647:n<-2147483648&&(n=-2147483648),n=+n,isNaN(n)&&(n=o?0:e.length-1),n<0&&(n=e.length+n),n>=e.length){if(o)return-1;n=e.length-1}else if(n<0){if(!o)return-1;n=0}if("string"==typeof t&&(t=D.from(t,r)),Y(t))return 0===t.length?-1:H(e,t,n,r,o);if("number"==typeof t)return t&=255,D.TYPED_ARRAY_SUPPORT&&"function"==typeof Uint8Array.prototype.indexOf?o?Uint8Array.prototype.indexOf.call(e,t,n):Uint8Array.prototype.lastIndexOf.call(e,t,n):H(e,[t],n,r,o);throw new TypeError("val must be string, number or Buffer")}function H(e,t,n,r,o){var i,s=1,a=e.length,c=t.length;if(void 0!==r&&("ucs2"===(r=String(r).toLowerCase())||"ucs-2"===r||"utf16le"===r||"utf-16le"===r)){if(e.length<2||t.length<2)return-1;s=2,a/=2,c/=2,n/=2}function u(e,t){return 1===s?e[t]:e.readUInt16BE(t*s)}if(o){var h=-1;for(i=n;i<a;i++)if(u(e,i)===u(t,-1===h?0:i-h)){if(-1===h&&(h=i),i-h+1===c)return h*s}else-1!==h&&(i-=i-h),h=-1}else for(n+c>a&&(n=a-c),i=n;i>=0;i--){for(var l=!0,d=0;d<c;d++)if(u(e,i+d)!==u(t,d)){l=!1;break}if(l)return i}return-1}function J(e,t,n,r){n=Number(n)||0;var o=e.length-n;r?(r=Number(r))>o&&(r=o):r=o;var i=t.length;if(i%2!=0)throw new TypeError("Invalid hex string");r>i/2&&(r=i/2);for(var s=0;s<r;++s){var a=parseInt(t.substr(2*s,2),16);if(isNaN(a))return s;e[n+s]=a}return s}function $(e,t,n,r){return ge(fe(t,e.length-n),e,n,r)}function W(e,t,n,r){return ge(function(e){for(var t=[],n=0;n<e.length;++n)t.push(255&e.charCodeAt(n));return t}(t),e,n,r)}function Q(e,t,n,r){return W(e,t,n,r)}function z(e,t,n,r){return ge(pe(t),e,n,r)}function q(e,t,n,r){return ge(function(e,t){for(var n,r,o,i=[],s=0;s<e.length&&!((t-=2)<0);++s)r=(n=e.charCodeAt(s))>>8,o=n%256,i.push(o),i.push(r);return i}(t,e.length-n),e,n,r)}function X(e,t,n){return 0===t&&n===e.length?m(e):m(e.slice(t,n))}function Z(e,t,n){n=Math.min(e.length,n);for(var r=[],o=t;o<n;){var i,s,a,c,u=e[o],h=null,l=u>239?4:u>223?3:u>191?2:1;if(o+l<=n)switch(l){case 1:u<128&&(h=u);break;case 2:128==(192&(i=e[o+1]))&&(c=(31&u)<<6|63&i)>127&&(h=c);break;case 3:i=e[o+1],s=e[o+2],128==(192&i)&&128==(192&s)&&(c=(15&u)<<12|(63&i)<<6|63&s)>2047&&(c<55296||c>57343)&&(h=c);break;case 4:i=e[o+1],s=e[o+2],a=e[o+3],128==(192&i)&&128==(192&s)&&128==(192&a)&&(c=(15&u)<<18|(63&i)<<12|(63&s)<<6|63&a)>65535&&c<1114112&&(h=c)}null===h?(h=65533,l=1):h>65535&&(h-=65536,r.push(h>>>10&1023|55296),h=56320|1023&h),r.push(h),o+=l}return function(e){var t=e.length;if(t<=K)return String.fromCharCode.apply(String,e);var n="",r=0;for(;r<t;)n+=String.fromCharCode.apply(String,e.slice(r,r+=K));return n}(r)}D.TYPED_ARRAY_SUPPORT=void 0===y.TYPED_ARRAY_SUPPORT||y.TYPED_ARRAY_SUPPORT,L(),D.poolSize=8192,D._augment=function(e){return e.__proto__=D.prototype,e},D.from=function(e,t,n){return P(null,e,t,n)},D.TYPED_ARRAY_SUPPORT&&(D.prototype.__proto__=Uint8Array.prototype,D.__proto__=Uint8Array),D.alloc=function(e,t,n){return function(e,t,n,r){return x(t),t<=0?U(e,t):void 0!==n?"string"==typeof r?U(e,t).fill(n,r):U(e,t).fill(n):U(e,t)}(null,e,t,n)},D.allocUnsafe=function(e){return B(null,e)},D.allocUnsafeSlow=function(e){return B(null,e)},D.isBuffer=function(e){return null!=e&&(!!e._isBuffer||Ee(e)||function(e){return"function"==typeof e.readFloatLE&&"function"==typeof e.slice&&Ee(e.slice(0,0))}(e))},D.compare=function(e,t){if(!Y(e)||!Y(t))throw new TypeError("Arguments must be Buffers");if(e===t)return 0;for(var n=e.length,r=t.length,o=0,i=Math.min(n,r);o<i;++o)if(e[o]!==t[o]){n=e[o],r=t[o];break}return n<r?-1:r<n?1:0},D.isEncoding=function(e){switch(String(e).toLowerCase()){case"hex":case"utf8":case"utf-8":case"ascii":case"latin1":case"binary":case"base64":case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return!0;default:return!1}},D.concat=function(e,t){if(!O(e))throw new TypeError('"list" argument must be an Array of Buffers');if(0===e.length)return D.alloc(0);var n;if(void 0===t)for(t=0,n=0;n<e.length;++n)t+=e[n].length;var r=D.allocUnsafe(t),o=0;for(n=0;n<e.length;++n){var i=e[n];if(!Y(i))throw new TypeError('"list" argument must be an Array of Buffers');i.copy(r,o),o+=i.length}return r},D.byteLength=V,D.prototype._isBuffer=!0,D.prototype.swap16=function(){var e=this.length;if(e%2!=0)throw new RangeError("Buffer size must be a multiple of 16-bits");for(var t=0;t<e;t+=2)G(this,t,t+1);return this},D.prototype.swap32=function(){var e=this.length;if(e%4!=0)throw new RangeError("Buffer size must be a multiple of 32-bits");for(var t=0;t<e;t+=4)G(this,t,t+3),G(this,t+1,t+2);return this},D.prototype.swap64=function(){var e=this.length;if(e%8!=0)throw new RangeError("Buffer size must be a multiple of 64-bits");for(var t=0;t<e;t+=8)G(this,t,t+7),G(this,t+1,t+6),G(this,t+2,t+5),G(this,t+3,t+4);return this},D.prototype.toString=function(){var e=0|this.length;return 0===e?"":0===arguments.length?Z(this,0,e):M.apply(this,arguments)},D.prototype.equals=function(e){if(!Y(e))throw new TypeError("Argument must be a Buffer");return this===e||0===D.compare(this,e)},D.prototype.inspect=function(){var e="";return this.length>0&&(e=this.toString("hex",0,50).match(/.{2}/g).join(" "),this.length>50&&(e+=" ... ")),"<Buffer "+e+">"},D.prototype.compare=function(e,t,n,r,o){if(!Y(e))throw new TypeError("Argument must be a Buffer");if(void 0===t&&(t=0),void 0===n&&(n=e?e.length:0),void 0===r&&(r=0),void 0===o&&(o=this.length),t<0||n>e.length||r<0||o>this.length)throw new RangeError("out of range index");if(r>=o&&t>=n)return 0;if(r>=o)return-1;if(t>=n)return 1;if(this===e)return 0;for(var i=(o>>>=0)-(r>>>=0),s=(n>>>=0)-(t>>>=0),a=Math.min(i,s),c=this.slice(r,o),u=e.slice(t,n),h=0;h<a;++h)if(c[h]!==u[h]){i=c[h],s=u[h];break}return i<s?-1:s<i?1:0},D.prototype.includes=function(e,t,n){return-1!==this.indexOf(e,t,n)},D.prototype.indexOf=function(e,t,n){return k(this,e,t,n,!0)},D.prototype.lastIndexOf=function(e,t,n){return k(this,e,t,n,!1)},D.prototype.write=function(e,t,n,r){if(void 0===t)r="utf8",n=this.length,t=0;else if(void 0===n&&"string"==typeof t)r=t,n=this.length,t=0;else{if(!isFinite(t))throw new Error("Buffer.write(string, encoding, offset[, length]) is no longer supported");t|=0,isFinite(n)?(n|=0,void 0===r&&(r="utf8")):(r=n,n=void 0)}var o=this.length-t;if((void 0===n||n>o)&&(n=o),e.length>0&&(n<0||t<0)||t>this.length)throw new RangeError("Attempt to write outside buffer bounds");r||(r="utf8");for(var i=!1;;)switch(r){case"hex":return J(this,e,t,n);case"utf8":case"utf-8":return $(this,e,t,n);case"ascii":return W(this,e,t,n);case"latin1":case"binary":return Q(this,e,t,n);case"base64":return z(this,e,t,n);case"ucs2":case"ucs-2":case"utf16le":case"utf-16le":return q(this,e,t,n);default:if(i)throw new TypeError("Unknown encoding: "+r);r=(""+r).toLowerCase(),i=!0}},D.prototype.toJSON=function(){return{type:"Buffer",data:Array.prototype.slice.call(this._arr||this,0)}};var K=4096;function ee(e,t,n){var r="";n=Math.min(e.length,n);for(var o=t;o<n;++o)r+=String.fromCharCode(127&e[o]);return r}function te(e,t,n){var r="";n=Math.min(e.length,n);for(var o=t;o<n;++o)r+=String.fromCharCode(e[o]);return r}function ne(e,t,n){var r=e.length;(!t||t<0)&&(t=0),(!n||n<0||n>r)&&(n=r);for(var o="",i=t;i<n;++i)o+=de(e[i]);return o}function re(e,t,n){for(var r=e.slice(t,n),o="",i=0;i<r.length;i+=2)o+=String.fromCharCode(r[i]+256*r[i+1]);return o}function oe(e,t,n){if(e%1!=0||e<0)throw new RangeError("offset is not uint");if(e+t>n)throw new RangeError("Trying to access beyond buffer length")}function ie(e,t,n,r,o,i){if(!Y(e))throw new TypeError('"buffer" argument must be a Buffer instance');if(t>o||t<i)throw new RangeError('"value" argument is out of bounds');if(n+r>e.length)throw new RangeError("Index out of range")}function se(e,t,n,r){t<0&&(t=65535+t+1);for(var o=0,i=Math.min(e.length-n,2);o<i;++o)e[n+o]=(t&255<<8*(r?o:1-o))>>>8*(r?o:1-o)}function ae(e,t,n,r){t<0&&(t=4294967295+t+1);for(var o=0,i=Math.min(e.length-n,4);o<i;++o)e[n+o]=t>>>8*(r?o:3-o)&255}function ce(e,t,n,r,o,i){if(n+r>e.length)throw new RangeError("Index out of range");if(n<0)throw new RangeError("Index out of range")}function ue(e,t,n,r,o){return o||ce(e,0,n,4),w(e,t,n,r,23,4),n+4}function he(e,t,n,r,o){return o||ce(e,0,n,8),w(e,t,n,r,52,8),n+8}D.prototype.slice=function(e,t){var n,r=this.length;if((e=~~e)<0?(e+=r)<0&&(e=0):e>r&&(e=r),(t=void 0===t?r:~~t)<0?(t+=r)<0&&(t=0):t>r&&(t=r),t<e&&(t=e),D.TYPED_ARRAY_SUPPORT)(n=this.subarray(e,t)).__proto__=D.prototype;else{var o=t-e;n=new D(o,void 0);for(var i=0;i<o;++i)n[i]=this[i+e]}return n},D.prototype.readUIntLE=function(e,t,n){e|=0,t|=0,n||oe(e,t,this.length);for(var r=this[e],o=1,i=0;++i<t&&(o*=256);)r+=this[e+i]*o;return r},D.prototype.readUIntBE=function(e,t,n){e|=0,t|=0,n||oe(e,t,this.length);for(var r=this[e+--t],o=1;t>0&&(o*=256);)r+=this[e+--t]*o;return r},D.prototype.readUInt8=function(e,t){return t||oe(e,1,this.length),this[e]},D.prototype.readUInt16LE=function(e,t){return t||oe(e,2,this.length),this[e]|this[e+1]<<8},D.prototype.readUInt16BE=function(e,t){return t||oe(e,2,this.length),this[e]<<8|this[e+1]},D.prototype.readUInt32LE=function(e,t){return t||oe(e,4,this.length),(this[e]|this[e+1]<<8|this[e+2]<<16)+16777216*this[e+3]},D.prototype.readUInt32BE=function(e,t){return t||oe(e,4,this.length),16777216*this[e]+(this[e+1]<<16|this[e+2]<<8|this[e+3])},D.prototype.readIntLE=function(e,t,n){e|=0,t|=0,n||oe(e,t,this.length);for(var r=this[e],o=1,i=0;++i<t&&(o*=256);)r+=this[e+i]*o;return r>=(o*=128)&&(r-=Math.pow(2,8*t)),r},D.prototype.readIntBE=function(e,t,n){e|=0,t|=0,n||oe(e,t,this.length);for(var r=t,o=1,i=this[e+--r];r>0&&(o*=256);)i+=this[e+--r]*o;return i>=(o*=128)&&(i-=Math.pow(2,8*t)),i},D.prototype.readInt8=function(e,t){return t||oe(e,1,this.length),128&this[e]?-1*(255-this[e]+1):this[e]},D.prototype.readInt16LE=function(e,t){t||oe(e,2,this.length);var n=this[e]|this[e+1]<<8;return 32768&n?4294901760|n:n},D.prototype.readInt16BE=function(e,t){t||oe(e,2,this.length);var n=this[e+1]|this[e]<<8;return 32768&n?4294901760|n:n},D.prototype.readInt32LE=function(e,t){return t||oe(e,4,this.length),this[e]|this[e+1]<<8|this[e+2]<<16|this[e+3]<<24},D.prototype.readInt32BE=function(e,t){return t||oe(e,4,this.length),this[e]<<24|this[e+1]<<16|this[e+2]<<8|this[e+3]},D.prototype.readFloatLE=function(e,t){return t||oe(e,4,this.length),R(this,e,!0,23,4)},D.prototype.readFloatBE=function(e,t){return t||oe(e,4,this.length),R(this,e,!1,23,4)},D.prototype.readDoubleLE=function(e,t){return t||oe(e,8,this.length),R(this,e,!0,52,8)},D.prototype.readDoubleBE=function(e,t){return t||oe(e,8,this.length),R(this,e,!1,52,8)},D.prototype.writeUIntLE=function(e,t,n,r){(e=+e,t|=0,n|=0,r)||ie(this,e,t,n,Math.pow(2,8*n)-1,0);var o=1,i=0;for(this[t]=255&e;++i<n&&(o*=256);)this[t+i]=e/o&255;return t+n},D.prototype.writeUIntBE=function(e,t,n,r){(e=+e,t|=0,n|=0,r)||ie(this,e,t,n,Math.pow(2,8*n)-1,0);var o=n-1,i=1;for(this[t+o]=255&e;--o>=0&&(i*=256);)this[t+o]=e/i&255;return t+n},D.prototype.writeUInt8=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,1,255,0),D.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),this[t]=255&e,t+1},D.prototype.writeUInt16LE=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,2,65535,0),D.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):se(this,e,t,!0),t+2},D.prototype.writeUInt16BE=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,2,65535,0),D.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):se(this,e,t,!1),t+2},D.prototype.writeUInt32LE=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,4,4294967295,0),D.TYPED_ARRAY_SUPPORT?(this[t+3]=e>>>24,this[t+2]=e>>>16,this[t+1]=e>>>8,this[t]=255&e):ae(this,e,t,!0),t+4},D.prototype.writeUInt32BE=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,4,4294967295,0),D.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):ae(this,e,t,!1),t+4},D.prototype.writeIntLE=function(e,t,n,r){if(e=+e,t|=0,!r){var o=Math.pow(2,8*n-1);ie(this,e,t,n,o-1,-o)}var i=0,s=1,a=0;for(this[t]=255&e;++i<n&&(s*=256);)e<0&&0===a&&0!==this[t+i-1]&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+n},D.prototype.writeIntBE=function(e,t,n,r){if(e=+e,t|=0,!r){var o=Math.pow(2,8*n-1);ie(this,e,t,n,o-1,-o)}var i=n-1,s=1,a=0;for(this[t+i]=255&e;--i>=0&&(s*=256);)e<0&&0===a&&0!==this[t+i+1]&&(a=1),this[t+i]=(e/s>>0)-a&255;return t+n},D.prototype.writeInt8=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,1,127,-128),D.TYPED_ARRAY_SUPPORT||(e=Math.floor(e)),e<0&&(e=255+e+1),this[t]=255&e,t+1},D.prototype.writeInt16LE=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,2,32767,-32768),D.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8):se(this,e,t,!0),t+2},D.prototype.writeInt16BE=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,2,32767,-32768),D.TYPED_ARRAY_SUPPORT?(this[t]=e>>>8,this[t+1]=255&e):se(this,e,t,!1),t+2},D.prototype.writeInt32LE=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,4,2147483647,-2147483648),D.TYPED_ARRAY_SUPPORT?(this[t]=255&e,this[t+1]=e>>>8,this[t+2]=e>>>16,this[t+3]=e>>>24):ae(this,e,t,!0),t+4},D.prototype.writeInt32BE=function(e,t,n){return e=+e,t|=0,n||ie(this,e,t,4,2147483647,-2147483648),e<0&&(e=4294967295+e+1),D.TYPED_ARRAY_SUPPORT?(this[t]=e>>>24,this[t+1]=e>>>16,this[t+2]=e>>>8,this[t+3]=255&e):ae(this,e,t,!1),t+4},D.prototype.writeFloatLE=function(e,t,n){return ue(this,e,t,!0,n)},D.prototype.writeFloatBE=function(e,t,n){return ue(this,e,t,!1,n)},D.prototype.writeDoubleLE=function(e,t,n){return he(this,e,t,!0,n)},D.prototype.writeDoubleBE=function(e,t,n){return he(this,e,t,!1,n)},D.prototype.copy=function(e,t,n,r){if(n||(n=0),r||0===r||(r=this.length),t>=e.length&&(t=e.length),t||(t=0),r>0&&r<n&&(r=n),r===n)return 0;if(0===e.length||0===this.length)return 0;if(t<0)throw new RangeError("targetStart out of bounds");if(n<0||n>=this.length)throw new RangeError("sourceStart out of bounds");if(r<0)throw new RangeError("sourceEnd out of bounds");r>this.length&&(r=this.length),e.length-t<r-n&&(r=e.length-t+n);var o,i=r-n;if(this===e&&n<t&&t<r)for(o=i-1;o>=0;--o)e[o+t]=this[o+n];else if(i<1e3||!D.TYPED_ARRAY_SUPPORT)for(o=0;o<i;++o)e[o+t]=this[o+n];else Uint8Array.prototype.set.call(e,this.subarray(n,n+i),t);return i},D.prototype.fill=function(e,t,n,r){if("string"==typeof e){if("string"==typeof t?(r=t,t=0,n=this.length):"string"==typeof n&&(r=n,n=this.length),1===e.length){var o=e.charCodeAt(0);o<256&&(e=o)}if(void 0!==r&&"string"!=typeof r)throw new TypeError("encoding must be a string");if("string"==typeof r&&!D.isEncoding(r))throw new TypeError("Unknown encoding: "+r)}else"number"==typeof e&&(e&=255);if(t<0||this.length<t||this.length<n)throw new RangeError("Out of range index");if(n<=t)return this;var i;if(t>>>=0,n=void 0===n?this.length:n>>>0,e||(e=0),"number"==typeof e)for(i=t;i<n;++i)this[i]=e;else{var s=Y(e)?e:fe(new D(e,r).toString()),a=s.length;for(i=0;i<n-t;++i)this[i+t]=s[i%a]}return this};var le=/[^+\/0-9A-Za-z-_]/g;function de(e){return e<16?"0"+e.toString(16):e.toString(16)}function fe(e,t){var n;t=t||1/0;for(var r=e.length,o=null,i=[],s=0;s<r;++s){if((n=e.charCodeAt(s))>55295&&n<57344){if(!o){if(n>56319){(t-=3)>-1&&i.push(239,191,189);continue}if(s+1===r){(t-=3)>-1&&i.push(239,191,189);continue}o=n;continue}if(n<56320){(t-=3)>-1&&i.push(239,191,189),o=n;continue}n=65536+(o-55296<<10|n-56320)}else o&&(t-=3)>-1&&i.push(239,191,189);if(o=null,n<128){if((t-=1)<0)break;i.push(n)}else if(n<2048){if((t-=2)<0)break;i.push(n>>6|192,63&n|128)}else if(n<65536){if((t-=3)<0)break;i.push(n>>12|224,n>>6&63|128,63&n|128)}else{if(!(n<1114112))throw new Error("Invalid code point");if((t-=4)<0)break;i.push(n>>18|240,n>>12&63|128,n>>6&63|128,63&n|128)}}return i}function pe(e){return function(e){var t,n,r,o,i,s;I||N();var a=e.length;if(a%4>0)throw new Error("Invalid string. Length must be a multiple of 4");i="="===e[a-2]?2:"="===e[a-1]?1:0,s=new A(3*a/4-i),r=i>0?a-4:a;var c=0;for(t=0,n=0;t<r;t+=4,n+=3)o=b[e.charCodeAt(t)]<<18|b[e.charCodeAt(t+1)]<<12|b[e.charCodeAt(t+2)]<<6|b[e.charCodeAt(t+3)],s[c++]=o>>16&255,s[c++]=o>>8&255,s[c++]=255&o;return 2===i?(o=b[e.charCodeAt(t)]<<2|b[e.charCodeAt(t+1)]>>4,s[c++]=255&o):1===i&&(o=b[e.charCodeAt(t)]<<10|b[e.charCodeAt(t+1)]<<4|b[e.charCodeAt(t+2)]>>2,s[c++]=o>>8&255,s[c++]=255&o),s}(function(e){if((e=function(e){return e.trim?e.trim():e.replace(/^\s+|\s+$/g,"")}(e).replace(le,"")).length<2)return"";for(;e.length%4!=0;)e+="=";return e}(e))}function ge(e,t,n,r){for(var o=0;o<r&&!(o+n>=t.length||o>=e.length);++o)t[o+n]=e[o];return o}function Ee(e){return!!e.constructor&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)}class Te extends v{is_connected=!1;device=void 0;is_reconnecting=!1;error=!1;disconnect(e=undefined){if(this.device){if(!e)return this.device.close();if(e.force)return this.device.close(3333)}}async reconnect(e){return this.is_reconnecting=!0,this.disconnect(),this.connect(e)}onConnected(){this.is_connected=!0,this.is_reconnecting=!1,this.error=!1}onDisconnected(e){this.device=void 0,this.is_connected=!1,!this.nearpay.isLogedIn()||!this.is_reconnecting&&this.error?this.nearpay.disconnectDevice():(!e.code||e.code&&3333!==e.code)&&this.listener.dispatchConnectivityChange(exports.CONNECTION_STATE.DISCONNECTED)}onError(e){this.error=!0}async onMessage(e){if("string"==typeof e.data)return this.connection_manager.reviceCommand(e.data);try{const t=D.from(e.data).toString(),n=JSON.parse(t);this.connection_manager.reciveJob(n.jobId,n)}catch(e){console.log({e:e})}}isConnected(){return this.is_connected}async send(e){const t=JSON.stringify(e),n=D.from(t);return this.connection_manager.sendJob(e.jobId,e,(()=>{this.device?.send(n)}))}async WsConnect(e){const[t,n]=await T.connect(e,{onConnected:this.onConnected.bind(this),ondisconnected:this.onDisconnected.bind(this),onError:this.onError.bind(this),onMessage:this.onMessage.bind(this)});return this.device=t,n}}class ve extends Te{static connector_name="Wireless";wsInfo=this.connectionInfo;getType(){return exports.NEARPAY_CONNECTOR.WS}static async isAvaiale(){return!0}getName(){return ve.connector_name}getIp(){return this.wsInfo.ip}getPort(){return this.wsInfo.port}async connect(e){const t=`ws://${this.wsInfo.ip}:${this.wsInfo.port}/connect/${e}`;return this.WsConnect(t)}}exports.NEARPAY_CONNECTOR=void 0,(exports.NEARPAY_CONNECTOR||(exports.NEARPAY_CONNECTOR={})).WS="Wireless";const ye={[exports.NEARPAY_CONNECTOR.WS]:ve};var _e,be;!function(e){e.PURCHASE="0",e.REFUND="1",e.RECONCILE="2",e.REVERSE="3",e.GET_PENDING_TRANSACTIONS="4",e.GET_REVERSIBLE_TRANSACTIONS="5",e.GET_REFUNDABLE_TRANSACTIONS="6",e.GET_TRANSACTION="7",e.GET_ALL_RECONCILIATIONS="8",e.GET_RECONCILIATION="9",e.LOGOUT="10"}(_e||(_e={})),function(e){e.CREATE="0",e.CANCEL="1",e.END="2"}(be||(be={}));const Ae={timeout:6e4},Ie="Message canceled for unexpected error";class Ne{lib_provider;inbox=[];constructor(e){this.lib_provider=e}async sendJob(e,t,n,{timeout:r=6e4}=Ae){return n(),new Promise(((n,r)=>{this.inbox.push({uuid:e,payload:t,reject:r,resolve:n,timeoutClear:()=>{}})}))}async reviceCommand(t){switch(t){case e.Paused:return void this.lib_provider.getListener().dispatchEvent("pause");case e.Resume:return void this.lib_provider.getListener().dispatchEvent("un-pause");case e.Busy:return this.lib_provider.getListener().dispatchEvent("connection-busy"),void this.lib_provider.getListener().dispatchConnectivityChange(exports.CONNECTION_STATE.LOGGED_OUT);case e.Paused_Mode:return this.lib_provider.getNearpay().cancelJob("You cant send messages while the pos are paused"),void this.lib_provider.getListener().dispatchEvent("pause");case e.Confirmed:return this.lib_provider.getListener().dispatchConnectivityChange(exports.CONNECTION_STATE.CONNECTED),this.lib_provider.getListener().dispatchEvent("connection-not-busy"),void this.lib_provider.getListener().dispatchEvent("un-pause");case e.Unauthorized:return void this.lib_provider.getListener().dispatchConnectivityChange(exports.CONNECTION_STATE.LOGGED_OUT)}}async reciveJob(e,t){const n=this.inbox.find((t=>t.uuid===e));if(void 0===n)return;const{resolve:r,timeoutClear:o}=n;r(t),o?.(),this.inbox=this.inbox.filter((t=>t.uuid!==e))}async rejectJob(e,t=Ie){const n=this.inbox.find((t=>t.uuid===e));if(void 0===n)return;const{payload:r,reject:o,timeoutClear:i}=n;this.sendCancel(n).then((()=>{o(t),i?.(),this.inbox=this.inbox.filter((t=>t.uuid!==e))}))}async rejectAllJobs(e=Ie){this.inbox.forEach((t=>{this.rejectJob(t.uuid,e)})),this.inbox=[]}async rejectLastJob(e=Ie){const t=this.inbox[this.inbox.length-1];if(void 0===t)return;const{uuid:n}=t;this.rejectJob(n,e)}hasPendingJob(){return this.inbox.length>0}async sendCancel(e){const t=this.lib_provider.getNearpay(),n={...e.payload,commandType:be.CANCEL};await t.send(n)}}const Ce=["connected","disconnected","state-connected","state-connecting","state-disconnected","state-logged_out","logout","connectivity-change","availablity-change","pay","payment-result","setup","send-message","recive-message","reject-message","pause","un-pause","connection-busy","connection-not-busy"];function me(e,t,...n){if(!e)throw new TypeError(Re(t,n))}function Re(e,t){let n=0;return e.replace(/%[os]/gu,(()=>we(t[n++])))}function we(e){return"object"!=typeof e||null===e?String(e):Object.prototype.toString.call(e)}const Se="undefined"!=typeof window?window:"undefined"!=typeof self?self:"undefined"!=typeof global?global:"undefined"!=typeof globalThis?globalThis:void 0;class Oe{constructor(e,t){this.code=e,this.message=t}warn(...e){var t;try{undefined;const n=(null!==(t=(new Error).stack)&&void 0!==t?t:"").replace(/^(?:.+?\n){2}/gu,"\n");console.warn(this.message,...e,n)}catch(e){}}}const Le=new Oe("W01","Unable to initialize event under dispatching."),Ue=new Oe("W02","Assigning any falsy value to 'cancelBubble' property has no effect."),De=new Oe("W03","Assigning any truthy value to 'returnValue' property has no effect."),Pe=new Oe("W04","Unable to preventDefault on non-cancelable events."),xe=new Oe("W05","Unable to preventDefault inside passive event listener invocation."),Be=new Oe("W06","An event listener wasn't added because it has been added already: %o, %o"),Fe=new Oe("W07","The %o option value was abandoned because the event listener wasn't added as duplicated."),je=new Oe("W08","The 'callback' argument must be a function or an object that has 'handleEvent' method: %o");class Ye{static get NONE(){return Ve}static get CAPTURING_PHASE(){return Me}static get AT_TARGET(){return Ge}static get BUBBLING_PHASE(){return ke}constructor(e,t){Object.defineProperty(this,"isTrusted",{value:!1,enumerable:!0});const n=null!=t?t:{};He.set(this,{type:String(e),bubbles:Boolean(n.bubbles),cancelable:Boolean(n.cancelable),composed:Boolean(n.composed),target:null,currentTarget:null,stopPropagationFlag:!1,stopImmediatePropagationFlag:!1,canceledFlag:!1,inPassiveListenerFlag:!1,dispatchFlag:!1,timeStamp:Date.now()})}get type(){return Je(this).type}get target(){return Je(this).target}get srcElement(){return Je(this).target}get currentTarget(){return Je(this).currentTarget}composedPath(){const e=Je(this).currentTarget;return e?[e]:[]}get NONE(){return Ve}get CAPTURING_PHASE(){return Me}get AT_TARGET(){return Ge}get BUBBLING_PHASE(){return ke}get eventPhase(){return Je(this).dispatchFlag?2:0}stopPropagation(){Je(this).stopPropagationFlag=!0}get cancelBubble(){return Je(this).stopPropagationFlag}set cancelBubble(e){e?Je(this).stopPropagationFlag=!0:Ue.warn()}stopImmediatePropagation(){const e=Je(this);e.stopPropagationFlag=e.stopImmediatePropagationFlag=!0}get bubbles(){return Je(this).bubbles}get cancelable(){return Je(this).cancelable}get returnValue(){return!Je(this).canceledFlag}set returnValue(e){e?De.warn():$e(Je(this))}preventDefault(){$e(Je(this))}get defaultPrevented(){return Je(this).canceledFlag}get composed(){return Je(this).composed}get isTrusted(){return!1}get timeStamp(){return Je(this).timeStamp}initEvent(e,t=!1,n=!1){const r=Je(this);r.dispatchFlag?Le.warn():He.set(this,{...r,type:String(e),bubbles:Boolean(t),cancelable:Boolean(n),target:null,currentTarget:null,stopPropagationFlag:!1,stopImmediatePropagationFlag:!1,canceledFlag:!1})}}const Ve=0,Me=1,Ge=2,ke=3,He=new WeakMap;function Je(e,t="this"){const n=He.get(e);return me(null!=n,"'%s' must be an object that Event constructor created, but got another one: %o",t,e),n}function $e(e){e.inPassiveListenerFlag?xe.warn():e.cancelable?e.canceledFlag=!0:Pe.warn()}Object.defineProperty(Ye,"NONE",{enumerable:!0}),Object.defineProperty(Ye,"CAPTURING_PHASE",{enumerable:!0}),Object.defineProperty(Ye,"AT_TARGET",{enumerable:!0}),Object.defineProperty(Ye,"BUBBLING_PHASE",{enumerable:!0});const We=Object.getOwnPropertyNames(Ye.prototype);for(let e=0;e<We.length;++e)"constructor"!==We[e]&&Object.defineProperty(Ye.prototype,We[e],{enumerable:!0});let Qe;void 0!==Se&&void 0!==Se.Event&&Object.setPrototypeOf(Ye.prototype,Se.Event.prototype);const ze={INDEX_SIZE_ERR:1,DOMSTRING_SIZE_ERR:2,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,INVALID_CHARACTER_ERR:5,NO_DATA_ALLOWED_ERR:6,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INUSE_ATTRIBUTE_ERR:10,INVALID_STATE_ERR:11,SYNTAX_ERR:12,INVALID_MODIFICATION_ERR:13,NAMESPACE_ERR:14,INVALID_ACCESS_ERR:15,VALIDATION_ERR:16,TYPE_MISMATCH_ERR:17,SECURITY_ERR:18,NETWORK_ERR:19,ABORT_ERR:20,URL_MISMATCH_ERR:21,QUOTA_EXCEEDED_ERR:22,TIMEOUT_ERR:23,INVALID_NODE_TYPE_ERR:24,DATA_CLONE_ERR:25};function qe(e){const t=Object.keys(ze);for(let n=0;n<t.length;++n){const r=t[n],o=ze[r];Object.defineProperty(e,r,{get:()=>o,configurable:!0,enumerable:!0})}}class Xe extends Ye{static wrap(e){return new(tt(e))(e)}constructor(e){super(e.type,{bubbles:e.bubbles,cancelable:e.cancelable,composed:e.composed}),e.cancelBubble&&super.stopPropagation(),e.defaultPrevented&&super.preventDefault(),Ze.set(this,{original:e});const t=Object.keys(e);for(let n=0;n<t.length;++n){const r=t[n];r in this||Object.defineProperty(this,r,nt(e,r))}}stopPropagation(){super.stopPropagation();const{original:e}=Ke(this);"stopPropagation"in e&&e.stopPropagation()}get cancelBubble(){return super.cancelBubble}set cancelBubble(e){super.cancelBubble=e;const{original:t}=Ke(this);"cancelBubble"in t&&(t.cancelBubble=e)}stopImmediatePropagation(){super.stopImmediatePropagation();const{original:e}=Ke(this);"stopImmediatePropagation"in e&&e.stopImmediatePropagation()}get returnValue(){return super.returnValue}set returnValue(e){super.returnValue=e;const{original:t}=Ke(this);"returnValue"in t&&(t.returnValue=e)}preventDefault(){super.preventDefault();const{original:e}=Ke(this);"preventDefault"in e&&e.preventDefault()}get timeStamp(){const{original:e}=Ke(this);return"timeStamp"in e?e.timeStamp:super.timeStamp}}const Ze=new WeakMap;function Ke(e){const t=Ze.get(e);return me(null!=t,"'this' is expected an Event object, but got",e),t}const et=new WeakMap;function tt(e){const t=Object.getPrototypeOf(e);if(null==t)return Xe;let n=et.get(t);return null==n&&(n=function(e,t){class n extends e{}const r=Object.keys(t);for(let e=0;e<r.length;++e)Object.defineProperty(n.prototype,r[e],nt(t,r[e]));return n}(tt(t),t),et.set(t,n)),n}function nt(e,t){const n=Object.getOwnPropertyDescriptor(e,t);return{get(){const e=Ke(this).original,n=e[t];return"function"==typeof n?n.bind(e):n},set(e){Ke(this).original[t]=e},configurable:n.configurable,enumerable:n.enumerable}}function rt(e){return 1==(1&e.flags)}function ot(e){return 2==(2&e.flags)}function it(e){return 4==(4&e.flags)}function st(e){return 8==(8&e.flags)}function at({callback:e},t,n){try{"function"==typeof e?e.call(t,n):"function"==typeof e.handleEvent&&e.handleEvent(n)}catch(e){!function(e){try{const t=e instanceof Error?e:new Error(we(e));if("function"==typeof dispatchEvent&&"function"==typeof ErrorEvent)dispatchEvent(new ErrorEvent("error",{error:t,message:t.message}));else if("undefined"!=typeof process&&"function"==typeof process.emit)return void process.emit("uncaughtException",t);console.error(t)}catch(e){}}(e)}}function ct({listeners:e},t,n){for(let r=0;r<e.length;++r)if(e[r].callback===t&&rt(e[r])===n)return r;return-1}function ut(e,t,n){const r=ct(e,t,n);return-1!==r&&ht(e,r)}function ht(e,t,n=!1){const r=e.listeners[t];return function(e){e.flags|=8}(r),r.signal&&r.signal.removeEventListener("abort",r.signalListener),e.cow&&!n?(e.cow=!1,e.listeners=e.listeners.filter(((e,n)=>n!==t)),!1):(e.listeners.splice(t,1),!0)}et.set(Object.prototype,Xe),void 0!==Se&&void 0!==Se.Event&&et.set(Se.Event.prototype,Xe);class lt{constructor(){dt.set(this,Object.create(null))}addEventListener(e,t,n){const r=ft(this),{callback:o,capture:i,once:s,passive:a,signal:c,type:u}=function(e,t,n){var r;if(pt(t),"object"==typeof n&&null!==n)return{type:String(e),callback:null!=t?t:void 0,capture:Boolean(n.capture),passive:Boolean(n.passive),once:Boolean(n.once),signal:null!==(r=n.signal)&&void 0!==r?r:void 0};return{type:String(e),callback:null!=t?t:void 0,capture:Boolean(n),passive:!1,once:!1,signal:void 0}}(e,t,n);if(null==o||(null==c?void 0:c.aborted))return;const h=function(e,t){var n;return null!==(n=e[t])&&void 0!==n?n:e[t]={attrCallback:void 0,attrListener:void 0,cow:!1,listeners:[]}}(r,u),l=ct(h,o,i);-1===l?function(e,t,n,r,o,i){let s;i&&(s=ut.bind(null,e,t,n),i.addEventListener("abort",s));const a=function(e,t,n,r,o,i){return{callback:e,flags:(t?1:0)|(n?2:0)|(r?4:0),signal:o,signalListener:i}}(t,n,r,o,i,s);e.cow?(e.cow=!1,e.listeners=[...e.listeners,a]):e.listeners.push(a)}(h,o,i,a,s,c):function(e,t,n,r){Be.warn(rt(e)?"capture":"bubble",e.callback),ot(e)!==t&&Fe.warn("passive");it(e)!==n&&Fe.warn("once");e.signal!==r&&Fe.warn("signal")}(h.listeners[l],a,s,c)}removeEventListener(e,t,n){const r=ft(this),{callback:o,capture:i,type:s}=function(e,t,n){if(pt(t),"object"==typeof n&&null!==n)return{type:String(e),callback:null!=t?t:void 0,capture:Boolean(n.capture)};return{type:String(e),callback:null!=t?t:void 0,capture:Boolean(n)}}(e,t,n),a=r[s];null!=o&&a&&ut(a,o,i)}dispatchEvent(e){const t=ft(this)[String(e.type)];if(null==t)return!0;const n=e instanceof Ye?e:Xe.wrap(e),r=Je(n,"event");if(r.dispatchFlag)throw o="This event has been in dispatching.",Se.DOMException?new Se.DOMException(o,"InvalidStateError"):(null==Qe&&(Qe=class e extends Error{constructor(t){super(t),Error.captureStackTrace&&Error.captureStackTrace(this,e)}get code(){return 11}get name(){return"InvalidStateError"}},Object.defineProperties(Qe.prototype,{code:{enumerable:!0},name:{enumerable:!0}}),qe(Qe),qe(Qe.prototype)),new Qe(o));var o;if(r.dispatchFlag=!0,r.target=r.currentTarget=this,!r.stopPropagationFlag){const{cow:e,listeners:o}=t;t.cow=!0;for(let i=0;i<o.length;++i){const s=o[i];if(!st(s)&&(it(s)&&ht(t,i,!e)&&(i-=1),r.inPassiveListenerFlag=ot(s),at(s,this,n),r.inPassiveListenerFlag=!1,r.stopImmediatePropagationFlag))break}e||(t.cow=!1)}return r.target=null,r.currentTarget=null,r.stopImmediatePropagationFlag=!1,r.stopPropagationFlag=!1,r.dispatchFlag=!1,!r.canceledFlag}}const dt=new WeakMap;function ft(e,t="this"){const n=dt.get(e);return me(null!=n,"'%s' must be an object that EventTarget constructor created, but got another one: %o",t,e),n}function pt(e){if("function"!=typeof e&&("object"!=typeof e||null===e||"function"!=typeof e.handleEvent)){if(null!=e&&"object"!=typeof e)throw new TypeError(Re(je.message,[e]));je.warn(e)}}const gt=Object.getOwnPropertyNames(lt.prototype);for(let e=0;e<gt.length;++e)"constructor"!==gt[e]&&Object.defineProperty(lt.prototype,gt[e],{enumerable:!0});void 0!==Se&&void 0!==Se.EventTarget&&Object.setPrototypeOf(lt.prototype,Se.EventTarget.prototype);class Et{lib_provider;constructor(e){this.lib_provider=e}event=new lt;addEventListener(e,t,n){if(!Ce.includes(e))throw Error("unsupported event type");return this.event.addEventListener(e,t,n),()=>this.removeEventListener(e,t,n)}removeEventListener(e,t,n){if(!Ce.includes(e))throw Error("unsupported event type");this.event.removeEventListener(e,t,n)}dispatchEvent(e){if(!Ce.includes(e))throw Error("unsupported event type");const t=new Ye(e);this.event.dispatchEvent(t)}dispatchConnectivityChange(e){this.dispatchEvent(`state-${e}`)}}function Tt({jobId:e,messageId:t,command:n,commandType:r,body:o}){return{jobId:e,messageId:t,command:n,commandType:r,metaData:{platform:"",device_id:"",device_user:"",os_version:"",sdk_version:"",payment_plugin_version:""},payload:o}}class vt{static PurchasePayload({jobId:e,messageId:t,commandType:n,body:r}){return Tt({jobId:e,messageId:t,command:_e.PURCHASE,commandType:n,body:r})}static RefundPayload({jobId:e,messageId:t,commandType:n,body:r}){return Tt({jobId:e,messageId:t,command:_e.REFUND,commandType:n,body:r})}static ReversalPayload({jobId:e,messageId:t,commandType:n,body:r}){return Tt({jobId:e,messageId:t,command:_e.REVERSE,commandType:n,body:r})}static ReconciliationPayload({jobId:e,messageId:t,commandType:n,body:r}){return Tt({jobId:e,messageId:t,command:_e.RECONCILE,commandType:n,body:r})}}class yt{lib_provider;constructor(e){this.lib_provider=e}update(){return this}async purchase({jobId:e=g(),messageId:t=g(),amount:n,enable_ui_dismiss:r=!0,reference_id:o="",enable_receipt_ui:i=!0,enable_reversal:s=!0,finish_timeout:a=6e4}){if(this.lib_provider.getNearpay().hasPendingJob())throw"connot send a job while there is a job pending";const c=vt.PurchasePayload({jobId:e,messageId:t,commandType:be.CREATE,body:{amount:n,customerReferenceNumber:o,enableReceiptUi:i,enableReversal:s,finishTimeOut:a,enableUiDismiss:r}});return this.lib_provider.getNearpay().send(c)}async refund({jobId:e=g(),messageId:t=g(),amount:n,original_transaction_uuid:r,enable_ui_dismiss:o=!0,reference_id:i="",enable_receipt_ui:s=!0,enable_reversal:a=!0,enable_editable_refund_amount_ui:c=!0,finish_timeout:u=6e4}){if(this.lib_provider.getNearpay().hasPendingJob())throw"connot send a job while there is a job pending";const h=vt.RefundPayload({jobId:e,messageId:t,commandType:be.CREATE,body:{amount:n,transactionUUID:r,customerReferenceNumber:i,enableReceiptUi:s,enableReversal:a,enableEditableRefundAmountUi:c,finishTimeOut:u,enableUiDismiss:o}});return this.lib_provider.getNearpay().send(h)}async reversal({jobId:e=g(),messageId:t=g(),original_transaction_uuid:n,enable_receipt_ui:r=!0,finish_timeout:o=6e4}){if(this.lib_provider.getNearpay().hasPendingJob())throw"connot send a job while there is a job pending";const i=vt.ReversalPayload({jobId:e,messageId:t,commandType:be.CREATE,body:{transactionUUID:n,enableReceiptUi:r,finishTimeOut:o}});return this.lib_provider.getNearpay().send(i)}async reconcile({jobId:e=g(),messageId:t=g(),enable_receipt_ui:n=!0,finish_timeout:r=6e4}){if(this.lib_provider.getNearpay().hasPendingJob())throw"connot send a job while there is a job pending";const o=vt.ReconciliationPayload({jobId:e,messageId:t,commandType:be.CREATE,body:{enableReceiptUi:n,finishTimeOut:r}});return this.lib_provider.getNearpay().send(o)}}class _t{constructor(e){this.nearpay=e,this.listener=new Et(this),this.connection_manager=new Ne(this),this.terminal=new yt(this)}terminal;nearpay;listener;connector=void 0;connection_manager;getTerminal(){return this.terminal}getNearpay(){return this.nearpay}getListener(){return this.listener}getConnector(){return this.connector}getConnectionManager(){return this.connection_manager}setConnector(e){this.connector=e}}class bt{static async get(e){return new Promise((async(t,n)=>{const[r]=await T.connect(e,{onMessage:function({data:e}){t(e),r.close()}})}))}}exports.NearPay=class{lib_provider=new _t(this);state=exports.CONNECTION_STATE.LOGGED_OUT;is_paused=!1;is_busy=!1;recovaryMode=!1;tryingToConnect=!1;is_loggedin=!1;constructor(){this.addConnectivityListener((e=>this.state=e)),this.addConnectivityListener((e=>{e===exports.CONNECTION_STATE.LOGGED_OUT&&(this.is_loggedin=!1,this.releaseConnector(),this.cancelJob())})),this.addConnectivityListener((e=>{e===exports.CONNECTION_STATE.CONNECTING?this.tryingToConnect=!0:this.tryingToConnect=!1})),this.addConnectivityListener((e=>{e===exports.CONNECTION_STATE.CONNECTED&&(this.is_loggedin=!0)})),this.addConnectivityListener((e=>{exports.CONNECTION_STATE.DISCONNECTED})),this.addPauseListener((e=>this.is_paused=e)),this.addBusyListener((e=>this.is_busy=e))}addConnectivityListener(e){const t=[this.lib_provider.getListener().addEventListener("state-connected",(function(){e(exports.CONNECTION_STATE.CONNECTED)})),this.lib_provider.getListener().addEventListener("state-disconnected",(function(){e(exports.CONNECTION_STATE.DISCONNECTED)})),this.lib_provider.getListener().addEventListener("state-connecting",(function(){e(exports.CONNECTION_STATE.CONNECTING)})),this.lib_provider.getListener().addEventListener("state-logged_out",(function(){e(exports.CONNECTION_STATE.LOGGED_OUT)}))];return()=>t.forEach((e=>e()))}addPauseListener(e){function t(t){e(!0)}function n(t){e(!1)}return this.lib_provider.getListener().addEventListener("un-pause",n),this.lib_provider.getListener().addEventListener("pause",t),()=>{this.lib_provider.getListener().removeEventListener("un-pause",n),this.lib_provider.getListener().removeEventListener("pause",t)}}addBusyListener(e){function t(t){e(!1)}function n(t){e(!0)}return this.lib_provider.getListener().addEventListener("connection-not-busy",t),this.lib_provider.getListener().addEventListener("connection-busy",n),()=>{this.lib_provider.getListener().removeEventListener("connection-not-busy",t),this.lib_provider.getListener().removeEventListener("connection-busy",n)}}addAutoReconnect(e=1e3){const t=setInterval((async()=>{if(this.state!==exports.CONNECTION_STATE.DISCONNECTED)return()=>{};const e=await this.getProfile();if(void 0===e)return()=>{};this.is_busy||this.reconnect(e.id).catch((e=>{}))}),e);return()=>clearInterval(t)}getConenctor(){return this.lib_provider.getConnector()}getConnectorType(){const e=this.lib_provider.getConnector();if(e)return e.getType()}getCurrentConnectionInfo(){const e=this.lib_provider.getConnector();if(e)return e.getConnectionInfo()}async getAvaliableConnector(){return[{name:ve.connector_name,type:exports.NEARPAY_CONNECTOR.WS,available:await ve.isAvaiale()}]}async releaseConnector(){const e=this.lib_provider.getConnector();e&&(e.disconnect({force:!0}),this.lib_provider.setConnector(void 0))}async connect(e){if(this.state===exports.CONNECTION_STATE.CONNECTED)return void alert("NearPay is already connected to POS device");this.disconnectDevice();const t=await this.checkProfileIdIsValid(e)?(await this.getProfile())?.id:await this.requestConnectionUuid(e);if(void 0!==t)return this.StartConnection(e,t);alert("NearPay is busy with other device")}async connectToLastUser(){if(this.state!==exports.CONNECTION_STATE.LOGGED_OUT)return;const e=await this.getLastConnection(),t=await this.getProfile();return void 0!==t&&void 0!==e?await this.StartConnection(e,t.id).catch((e=>{})):void 0}async reconnect(e){if(this.tryingToConnect)return;const t=this.getConenctor();return t?(this.lib_provider.getListener().dispatchConnectivityChange(exports.CONNECTION_STATE.CONNECTING),t.reconnect(e)):void 0}async send(e){const t=this.lib_provider.getConnector();if(void 0!==t&&this.isConnected()){if(!this.is_paused)return t.send(e).then((e=>e));alert("cannot send message while the pos in pause mode")}else alert("cannot send message with no connection")}cancelJob(e="Job canceled"){this.lib_provider.getConnectionManager().hasPendingJob()&&this.lib_provider.getConnectionManager().rejectAllJobs(e)}isConnected(){const e=this.lib_provider.getConnector();return void 0!==e&&e.isConnected()}isLogedIn(){return this.is_loggedin}getState(){return this.state}isPaused(){return this.is_paused}isBusy(){return this.is_busy}disconnectDevice(){this.lib_provider.getListener().dispatchConnectivityChange(exports.CONNECTION_STATE.LOGGED_OUT)}async forgetDevice(){const e=await this.getProfile();if(void 0===e)return;const t=this.getConenctor()?.getConnectionInfo();return void 0!==t?await bt.get(`ws://${t.ip}:${t.port}/forget/${e.id}`).then((e=>"confirmed"===e)).finally((()=>this.disconnectDevice())):void 0}getTerminal(){return this.lib_provider.getTerminal()}hasPendingJob(){return this.lib_provider.getConnectionManager().hasPendingJob()}recoveryAfterDisconnection(){this.addConnectivityListener((e=>{let t=0;if(e!==exports.CONNECTION_STATE.CONNECTED&&e!==exports.CONNECTION_STATE.LOGGED_OUT){if(e===exports.CONNECTION_STATE.DISCONNECTED&&this.hasPendingJob()&&!this.recovaryMode){this.recovaryMode=!0;const e=setInterval((async()=>{t>=10&&(this.recovaryMode=!1,clearInterval(e),this.cancelJob("Job canceled for disconnection")),this.state===exports.CONNECTION_STATE.CONNECTED&&(this.recovaryMode=!1,clearInterval(e)),t++;const n=await this.getIdOrGenerate();this.reconnect(n)}),200)}}else this.recovaryMode=!1}))}async getIdOrGenerate(){return await this.getProfile().then((e=>e?.id??g()))}async checkProfileIdIsValid(e){const t=await this.getProfile();return void 0!==t&&await bt.get(`ws://${e.ip}:${e.port}/check/${t.id}`).then((e=>"valid"===e))}async requestConnectionUuid(e){return await bt.get(`ws://${e.ip}:${e.port}/pair`).then((e=>"busy"===e?void 0:/uuid:(.*)/.exec(e)?.at(1)))}async StartConnection(e,t){const n=new(0,ye[e.type])(this,this.lib_provider.getConnectionManager(),this.lib_provider.getListener(),e);return this.lib_provider.setConnector(n),this.lib_provider.getListener().dispatchConnectivityChange(exports.CONNECTION_STATE.CONNECTING),n.connect(t).then((()=>{this.saveProfile({id:t}),this.saveConnection(e)})).catch((e=>{throw this.disconnectDevice(),e}))}async getProfile(){throw"You must override the method (getProfile)"}async saveProfile(e){throw"You must override the method (saveProfile)"}async getLastConnection(){throw"You must override the method (getLastConnection)"}async saveConnection(e){throw"You must override the method (saveConnection)"}};
